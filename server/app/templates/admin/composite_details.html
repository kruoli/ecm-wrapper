{% extends "base.html" %}

{% block title %}Composite Details - {{ composite.id }}{% endblock %}

{% block extra_head %}
<script>
    // Check if API key exists, redirect to login if not
    if (!sessionStorage.getItem('admin_api_key')) {
        window.location.href = '/api/v1/admin/login';
    }

    // Add API key to all fetch requests
    function fetchWithAuth(url, options = {}) {
        options.headers = options.headers || {};
        options.headers['X-Admin-Key'] = sessionStorage.getItem('admin_api_key');
        return fetch(url, options).then(response => {
            if (response.status === 401) {
                sessionStorage.removeItem('admin_api_key');
                window.location.href = '/api/v1/admin/login';
                throw new Error('Unauthorized');
            }
            return response;
        });
    }

    // Navigate with auth header
    function navigateWithAuth(url) {
        fetchWithAuth(url)
            .then(response => response.text())
            .then(html => {
                document.open();
                document.write(html);
                document.close();
                history.pushState(null, '', url);
            })
            .catch(error => {
                console.error('Navigation error:', error);
            });
    }

    // Reload current page with auth
    function reloadWithAuth() {
        navigateWithAuth(window.location.pathname + window.location.search);
    }

    window.backToDashboard = function backToDashboard() {
        navigateWithAuth('/api/v1/admin/dashboard');
    }

    window.deleteComposite = function deleteComposite() {
        const apiKey = sessionStorage.getItem('admin_api_key');
        if (!apiKey) {
            window.location.href = '/api/v1/admin/login';
            return;
        }

        const compositeId = {{ composite.id }};
        const compositeNumber = "{{ composite.number[:50] }}...";

        if (!confirm(`Are you sure you want to delete composite ${compositeId}?\n\nNumber: ${compositeNumber}\n\nThis will permanently delete:\n- The composite record\n- All ECM attempts\n- All factors found\n- All work assignments\n\nThis action cannot be undone.`)) {
            return;
        }

        // Show loading state
        const deleteBtn = document.getElementById('delete-btn');
        const originalText = deleteBtn.textContent;
        deleteBtn.textContent = 'Deleting...';
        deleteBtn.disabled = true;

        fetch(`/api/v1/admin/composites/${compositeId}?reason=admin_manual_delete`, {
            method: 'DELETE',
            headers: {
                'X-Admin-Key': apiKey
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Delete failed: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            alert(`Successfully deleted composite ${compositeId}\n\nDeleted:\n- ${result.deleted_attempts} attempts\n- ${result.deleted_factors} factors\n- ${result.deleted_work_assignments} work assignments`);
            backToDashboard();
        })
        .catch(error => {
            alert(`Failed to delete composite: ${error.message}`);
            deleteBtn.textContent = originalText;
            deleteBtn.disabled = false;
        });
    }

    window.recalculateComposite = function recalculateComposite() {
        const apiKey = sessionStorage.getItem('admin_api_key');
        if (!apiKey) {
            window.location.href = '/api/v1/admin/login';
            return;
        }

        const compositeId = {{ composite.id }};

        // Show loading state
        const recalcBtn = document.getElementById('recalc-btn');
        const originalText = recalcBtn.textContent;
        recalcBtn.textContent = '‚è≥ Recalculating...';
        recalcBtn.disabled = true;

        fetch(`/api/v1/admin/composites/${compositeId}/recalculate-t-level`, {
            method: 'POST',
            headers: {
                'X-Admin-Key': apiKey
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error(`Recalculation failed: ${response.status}`);
            }
            return response.json();
        })
        .then(result => {
            const oldCurrent = result.old_current_t_level !== null ? `t${result.old_current_t_level}` : 'N/A';
            const newCurrent = result.new_current_t_level !== null ? `t${result.new_current_t_level}` : 'N/A';
            const oldTarget = result.old_target_t_level !== null ? `t${result.old_target_t_level}` : 'N/A';
            const newTarget = result.new_target_t_level !== null ? `t${result.new_target_t_level}` : 'N/A';

            alert(`T-level recalculated for composite ${compositeId}\n\nCurrent: ${oldCurrent} ‚Üí ${newCurrent}\nTarget: ${oldTarget} ‚Üí ${newTarget}`);

            // Reload page to show updated values
            reloadWithAuth();
        })
        .catch(error => {
            alert(`Failed to recalculate t-level: ${error.message}`);
            recalcBtn.textContent = originalText;
            recalcBtn.disabled = false;
        });
    }

    window.deleteAttempt = function deleteAttempt(attemptId, method, curves) {
        const apiKey = sessionStorage.getItem('admin_api_key');
        if (!apiKey) {
            window.location.href = '/api/v1/admin/login';
            return;
        }

        const compositeId = {{ composite.id }};

        if (!confirm(`Are you sure you want to delete attempt #${attemptId}?\n\nMethod: ${method}\nCurves: ${curves}\n\nThe composite's t-level will be recalculated after deletion.\n\nThis action cannot be undone.`)) {
            return;
        }

        // Show loading state on the button
        const deleteBtn = document.getElementById(`delete-attempt-${attemptId}`);
        if (deleteBtn) {
            deleteBtn.textContent = '...';
            deleteBtn.disabled = true;
        }

        fetch(`/api/v1/admin/attempts/${attemptId}?composite_id=${compositeId}`, {
            method: 'DELETE',
            headers: {
                'X-Admin-Key': apiKey
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(err.detail || `Delete failed: ${response.status}`);
                });
            }
            return response.json();
        })
        .then(result => {
            alert(`Deleted attempt #${attemptId}\n\nT-level: t${result.old_t_level} ‚Üí t${result.new_t_level}`);
            // Reload page to show updated table
            reloadWithAuth();
        })
        .catch(error => {
            alert(`Failed to delete attempt: ${error.message}`);
            if (deleteBtn) {
                deleteBtn.textContent = 'üóëÔ∏è';
                deleteBtn.disabled = false;
            }
        });
    }
</script>
<style>
    .btn-danger {
        background-color: #dc3545;
        color: white;
        border: 1px solid #dc3545;
    }
    .btn-danger:hover {
        background-color: #c82333;
        border-color: #bd2130;
    }
    .header-actions {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
    }
</style>
{% endblock %}

{% block body %}
<div class="container">
    <div class="header">
        <h1>Composite Details</h1>
        <div class="header-actions">
            <button onclick="backToDashboard()" class="btn btn-secondary">‚Üê Back to Dashboard</button>
            <button onclick="reloadWithAuth()" class="btn" style="background: #28a745;">üîÑ Refresh</button>
            <button id="recalc-btn" onclick="recalculateComposite()" class="btn btn-primary">üîÑ Recalculate T-Level</button>
            <button id="delete-btn" onclick="deleteComposite()" class="btn btn-danger">üóëÔ∏è Delete Composite</button>
        </div>
    </div>

    <div class="card">
        <h2>Composite Information</h2>
        <table>
            <tr><th>ID</th><td>{{ composite.id }}</td></tr>
            <tr><th>Number</th><td class="number-display">{{ esc(composite.number) }}</td></tr>
            <tr><th>Digit Length</th><td>{{ composite.digit_length }}</td></tr>
            <tr><th>Priority</th><td>{{ composite.priority }}</td></tr>
            <tr><th>Created</th><td>{{ esc(composite.created_at) }}</td></tr>
            <tr><th>Last Updated</th><td>{{ esc(composite.updated_at) }}</td></tr>
            <tr><th>Status</th><td>
                {% if composite.is_complete and composite.is_fully_factored %}
                <span class="status-badge status-complete">Complete</span>
                {% elif composite.is_complete %}
                <span class="status-badge status-complete">Sufficient</span>
                {% elif composite.is_fully_factored %}
                <span class="status-badge status-complete">Fully Factored</span>
                {% else %}
                <span class="status-badge status-active">Active</span>
                {% endif %}
            </td></tr>
        </table>
    </div>

    {% set current_t = composite.current_t_level or 0 %}
    {% set target_t = composite.target_t_level if composite.target_t_level else 0 %}
    {% set progress_pct = (current_t / target_t * 100) if target_t > 0 else 0 %}
    <div class="card">
        <h2>T-Level Progress
            {% if composite.prior_t_level %}
            <span style="display: inline-block; margin-left: 10px; padding: 3px 8px; background: #17a2b8; color: white; border-radius: 4px; font-size: 0.6em; font-weight: bold; vertical-align: middle;">PRIOR T-LEVEL APPLIED</span>
            {% endif %}
        </h2>
        <table>
            {% if composite.prior_t_level %}
            <tr><th>Prior T-Level</th><td>t{{ composite.prior_t_level|round(2) }} <span style="color: #666; font-size: 0.85em;">(imported from previous work)</span></td></tr>
            {% endif %}
            <tr><th>Current T-Level</th><td><strong>t{{ current_t|round(2) }}</strong>{% if composite.prior_t_level %} <span style="color: #666; font-size: 0.85em;">(includes prior work)</span>{% endif %}</td></tr>
            <tr><th>Target T-Level</th><td>t{{ target_t|round(2) }}</td></tr>
            <tr><th>Progress</th><td>
                <div class="progress-bar-container">
                    <div class="progress-fill" style="width: {{ [progress_pct, 100]|min|round(1) }}%">
                        {{ progress_pct|round(1) }}%
                    </div>
                </div>
            </td></tr>
        </table>
    </div>

    <div class="card">
        <h2>Work Summary</h2>
        <table>
            <tr><th>Total Attempts</th><td>{{ progress.total_attempts }}</td></tr>
            <tr><th>Total ECM Curves</th><td>{{ "{:,}".format(progress.total_ecm_curves) }}</td></tr>
            <tr><th>P-1 Attempts</th><td>{{ progress.pm1_attempts }}</td></tr>
            <tr><th>Factors Found</th><td>{{ progress.factors_found|length }}</td></tr>
        </table>
    </div>

    {% if active_work %}
    <div class="card">
        <h2>Active Work Assignments</h2>
        <div class="table-wrapper">
            <table>
                <tr>
                    <th>Client ID</th>
                    <th>Method</th>
                    <th>B1</th>
                    <th>B2</th>
                    <th>Curves Requested</th>
                    <th>Status</th>
                    <th>Expires</th>
                </tr>
                {% for work in active_work %}
                <tr>
                    <td>{{ esc(work.client_id) }}</td>
                    <td>{{ esc(work.method) }}</td>
                    <td>{{ "{:,}".format(work.b1) }}</td>
                    <td>{% if work.b2 is none %}Default{% elif work.b2 == 0 %}Stage 1 only{% else %}{{ "{:,}".format(work.b2) }}{% endif %}</td>
                    <td>{{ work.curves_requested }}</td>
                    <td>{{ esc(work.status) }}</td>
                    <td>{{ esc(work.expires_at) }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    {% endif %}

    {% if factors_with_group_orders %}
    <div class="card">
        <h2>Factors with Elliptic Curve Group Order Data</h2>
        <div class="table-wrapper">
            <table>
                <tr>
                    <th>Factor</th>
                    <th>Sigma</th>
                    <th>Group Order</th>
                    <th>Group Order Factorization</th>
                </tr>
                {% for f in factors_with_group_orders %}
                <tr>
                    <td class="number-display">{{ esc(f.factor) }}</td>
                    <td>{{ "{:,}".format(f.sigma|int) if f.sigma else "N/A" }}</td>
                    <td class="number-display">{{ esc(f.group_order) if f.group_order else "N/A" }}</td>
                    <td class="number-display">{{ esc(f.group_order_factorization) if f.group_order_factorization else "N/A" }}</td>
                </tr>
                {% endfor %}
            </table>
        </div>
    </div>
    {% endif %}

    <div class="card">
        <h2>Recent ECM Attempts</h2>
        {% if recent_attempts %}
        <div class="table-wrapper">
            <table>
                <tr>
                    <th>ID</th>
                    <th>Method</th>
                    <th>B1</th>
                    <th>B2</th>
                    <th>Curves Completed</th>
                    <th>Factor Found</th>
                    <th>Client</th>
                    <th>Submitted</th>
                    <th>Actions</th>
                </tr>
                {% for attempt in recent_attempts %}
                <tr {% if attempt.superseded_by %}style="opacity: 0.5; background-color: #f9f9f9;"{% endif %}>
                    <td>{{ attempt.id }}</td>
                    <td>{{ esc(attempt.method) }}</td>
                    <td>{{ "{:,}".format(attempt.b1) }}</td>
                    <td>
                        {% if attempt.b2 is none %}Default{% elif attempt.b2 == 0 %}
                        <span>Stage 1 only</span>
                        {% if attempt.superseded_by %}
                        <span style="display: inline-block; margin-left: 5px; padding: 2px 6px; background: #f39c12; color: white; border-radius: 3px; font-size: 0.75em; font-weight: bold;" title="Superseded by attempt #{{ attempt.superseded_by }}">SUPERSEDED</span>
                        {% endif %}
                        {% else %}{{ "{:,}".format(attempt.b2) }}{% endif %}
                    </td>
                    <td>{{ "{:,}".format(attempt.curves_completed) }}</td>
                    <td>
                        {% if attempt.factor_found %}
                        {# Check if multiple factors were found by this attempt #}
                        {% set attempt_factors = db.query(Factor).filter(Factor.found_by_attempt_id == attempt.id).all() %}
                        {% if attempt_factors|length > 1 %}
                        <span style="cursor: help;" title="This attempt found {{ attempt_factors|length }} factors total">
                            {{ esc(attempt.factor_found[:30]) }}... <strong style="color: #2ecc71;">[+{{ attempt_factors|length - 1 }} more]</strong>
                        </span>
                        {% else %}
                        {{ esc(attempt.factor_found) }}
                        {% endif %}
                        {% else %}
                        None
                        {% endif %}
                    </td>
                    <td>{{ esc(attempt.client_id) }}</td>
                    <td>{{ esc(attempt.created_at) }}</td>
                    <td>
                        <button id="delete-attempt-{{ attempt.id }}"
                                onclick="deleteAttempt({{ attempt.id }}, '{{ attempt.method }}', {{ attempt.curves_completed }})"
                                class="btn btn-danger"
                                style="padding: 2px 8px; font-size: 0.85em;"
                                title="Delete attempt #{{ attempt.id }}">üóëÔ∏è</button>
                    </td>
                </tr>
                {% endfor %}
            </table>
        </div>
        {% else %}
        <p>No attempts yet.</p>
        {% endif %}
    </div>
</div>
{% endblock %}
