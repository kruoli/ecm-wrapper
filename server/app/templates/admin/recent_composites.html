{% extends "base.html" %}

{% block title %}Recent Composites - ECM Admin{% endblock %}

{% block extra_head %}
<script>
    // Check if API key exists, redirect to login if not
    if (!sessionStorage.getItem('admin_api_key')) {
        window.location.href = '/api/v1/admin/login';
    }

    // Add API key to all fetch requests
    function fetchWithAuth(url, options = {}) {
        options.headers = options.headers || {};
        options.headers['X-Admin-Key'] = sessionStorage.getItem('admin_api_key');
        return fetch(url, options).then(response => {
            if (response.status === 401) {
                sessionStorage.removeItem('admin_api_key');
                window.location.href = '/api/v1/admin/login';
                throw new Error('Unauthorized');
            }
            return response;
        });
    }

    // Logout function
    function logout() {
        sessionStorage.removeItem('admin_api_key');
        window.location.href = '/api/v1/admin/login';
    }
</script>
{% endblock %}

{% block body %}
<div class="header">
    <div style="display: flex; justify-content: space-between; align-items: center;">
        <div>
            <h1>üìÖ Recent Composites</h1>
            <p>View and manage recently added composites</p>
        </div>
        <button onclick="logout()" class="btn" style="background: #dc3545;">Logout</button>
    </div>
</div>

<!-- Navigation Menu -->
<div class="section">
    <div class="section-content" style="padding: 10px 20px;">
        <nav style="display: flex; gap: 15px; flex-wrap: wrap;">
            <a href="/api/v1/admin/dashboard" class="btn">üè† Main Dashboard</a>
            <a href="/api/v1/admin/inactive-composites" class="btn">üí§ Inactive Composites</a>
            <a href="/api/v1/admin/outstanding-work" class="btn">‚è≥ Outstanding Work</a>
            <a href="/api/v1/admin/recent-composites" class="btn" style="background: #6c757d; color: white;">üìÖ Recent Composites</a>
        </nav>
    </div>
</div>

<!-- Summary Stats -->
<div class="section">
    <div class="section-header">üìä Summary</div>
    <div class="section-content">
        <p><strong>Total Recent Composites (last {{ days }} days):</strong> {{ total }}</p>
        <form onsubmit="changeDaysFilter(event)" style="margin-top: 10px;">
            <label>Show composites from last:</label>
            <select id="days-filter" onchange="this.form.submit()" style="padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                <option value="7" {{ 'selected' if days == 7 else '' }}>7 days</option>
                <option value="14" {{ 'selected' if days == 14 else '' }}>14 days</option>
                <option value="30" {{ 'selected' if days == 30 else '' }}>30 days</option>
                <option value="60" {{ 'selected' if days == 60 else '' }}>60 days</option>
                <option value="90" {{ 'selected' if days == 90 else '' }}>90 days</option>
            </select>
        </form>
    </div>
</div>

<!-- Recent Composites Table -->
<div class="section">
    <div class="section-header">üìÖ Recently Added Composites</div>
    <div class="section-content">
        {% if composites %}
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Number</th>
                        <th>Digits</th>
                        <th>Created At</th>
                        <th>Target T-Level</th>
                        <th>Priority</th>
                        <th>Active Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for composite in composites %}
                    <tr>
                        <td>{{ composite.id }}</td>
                        <td>
                            <a href="/api/v1/admin/composites/{{ composite.id }}/details" class="number">
                                {{ esc(format_composite(composite.number, 40)) }}
                            </a>
                        </td>
                        <td>{{ composite.digit_length }}</td>
                        <td>{{ composite.created_at.strftime('%Y-%m-%d %H:%M') if composite.created_at else 'N/A' }}</td>
                        <td>{{ composite.target_t_level|round(1) if composite.target_t_level else 'N/A' }}</td>
                        <td>
                            <input type="number"
                                   id="priority-{{ composite.id }}"
                                   value="{{ composite.priority }}"
                                   style="width: 60px; padding: 4px;"
                                   onchange="updatePriority({{ composite.id }}, this.value)">
                        </td>
                        <td>
                            <span id="active-badge-{{ composite.id }}"
                                  class="status-badge"
                                  style="padding: 4px 8px; border-radius: 4px; font-weight: bold;
                                         background: {{ '#28a745' if composite.is_active else '#6c757d' }};
                                         color: white;">
                                {{ 'Active' if composite.is_active else 'Inactive' }}
                            </span>
                        </td>
                        <td>
                            {% if composite.is_active %}
                            <button id="toggle-btn-{{ composite.id }}"
                                    onclick="deactivateComposite({{ composite.id }})"
                                    class="btn"
                                    style="background: #6c757d; font-size: 0.85em;">
                                Deactivate
                            </button>
                            {% else %}
                            <button id="toggle-btn-{{ composite.id }}"
                                    onclick="activateComposite({{ composite.id }})"
                                    class="btn"
                                    style="background: #28a745; font-size: 0.85em;">
                                Activate
                            </button>
                            {% endif %}
                            <button onclick="viewDetails({{ composite.id }})" class="btn" style="font-size: 0.85em;">
                                Details
                            </button>
                            <button onclick="deleteComposite({{ composite.id }})"
                                    class="btn"
                                    style="background: #dc3545; font-size: 0.85em;">
                                Delete
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>Showing {{ showing_from }}-{{ showing_to }} of {{ total }}</div>
            <div style="display: flex; gap: 10px;">
                {% if has_prev %}
                <button onclick="navigatePage({{ offset - limit }})" class="btn">Previous</button>
                {% endif %}
                <span style="padding: 8px 16px;">Page {{ page }} of {{ total_pages }}</span>
                {% if has_next %}
                <button onclick="navigatePage({{ offset + limit }})" class="btn">Next</button>
                {% endif %}
            </div>
        </div>

        {% else %}
        <p>No composites added in the last {{ days }} days.</p>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function changeDaysFilter(event) {
    event.preventDefault();
    const days = document.getElementById('days-filter').value;
    location.href = `/api/v1/admin/recent-composites?days=${days}&limit={{ limit }}`;
}

function activateComposite(compositeId) {
    fetchWithAuth(`/api/v1/admin/composites/${compositeId}/activate`, {
        method: 'PUT'
    })
    .then(response => response.json())
    .then(data => {
        // Update badge without full reload
        const badge = document.getElementById(`active-badge-${compositeId}`);
        badge.textContent = 'Active';
        badge.style.background = '#28a745';

        // Replace button
        const button = document.getElementById(`toggle-btn-${compositeId}`);
        button.textContent = 'Deactivate';
        button.style.background = '#6c757d';
        button.onclick = function() { deactivateComposite(compositeId); };

        alert(`Composite ${compositeId} activated`);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to activate composite');
    });
}

function deactivateComposite(compositeId) {
    fetchWithAuth(`/api/v1/admin/composites/${compositeId}/deactivate`, {
        method: 'PUT'
    })
    .then(response => response.json())
    .then(data => {
        // Update badge without full reload
        const badge = document.getElementById(`active-badge-${compositeId}`);
        badge.textContent = 'Inactive';
        badge.style.background = '#6c757d';

        // Replace button
        const button = document.getElementById(`toggle-btn-${compositeId}`);
        button.textContent = 'Activate';
        button.style.background = '#28a745';
        button.onclick = function() { activateComposite(compositeId); };

        alert(`Composite ${compositeId} deactivated`);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to deactivate composite');
    });
}

function updatePriority(compositeId, newPriority) {
    fetchWithAuth(`/api/v1/admin/composites/${compositeId}/priority?priority=${newPriority}`, {
        method: 'PUT'
    })
    .then(response => response.json())
    .then(data => {
        // Visual feedback without reload
        const input = document.getElementById(`priority-${compositeId}`);
        input.style.borderColor = '#28a745';
        setTimeout(() => { input.style.borderColor = ''; }, 1000);
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to update priority');
    });
}

function viewDetails(compositeId) {
    location.href = `/api/v1/admin/composites/${compositeId}/details`;
}

function deleteComposite(compositeId) {
    if (!confirm(`Delete composite ${compositeId}? This cannot be undone.`)) return;

    fetchWithAuth(`/api/v1/admin/composites/${compositeId}`, {
        method: 'DELETE'
    })
    .then(response => response.json())
    .then(data => {
        alert(`Composite ${compositeId} deleted`);
        location.reload();
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Failed to delete composite');
    });
}

function navigatePage(newOffset) {
    const params = new URLSearchParams(location.search);
    params.set('offset', newOffset);
    params.set('limit', '{{ limit }}');
    location.href = `/api/v1/admin/recent-composites?${params.toString()}`;
}
</script>
{% endblock %}
