{% extends "base.html" %}

{% block title %}ECM Distributed Factorization Dashboard{% endblock %}

{% block extra_head %}
<script>
    function toggleExpand(compositeId) {
        // Get the icon
        const icon = document.getElementById(`expand-icon-${compositeId}`);

        // Get all detail rows for this composite
        const detailRows = document.querySelectorAll(`tr[id^="detail-${compositeId}-"]`);

        // Toggle visibility
        const isExpanded = detailRows[0] && detailRows[0].style.display !== 'none';

        detailRows.forEach(row => {
            row.style.display = isExpanded ? 'none' : 'table-row';
        });

        // Toggle icon
        icon.textContent = isExpanded ? '‚ñ∂' : '‚ñº';
    }
</script>
{% endblock %}

{% block body %}
<h1>ECM Distributed Factorization Dashboard</h1>

<div style="margin-bottom: 20px; padding: 12px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div style="display: flex; gap: 10px; flex-wrap: wrap; align-items: center;">
        <a href="/api/v1/dashboard/testing-status" class="btn btn-primary">
            ECM Testing Status
        </a>
        <a href="/api/v1/dashboard/p1-testing-status" class="btn" style="background: #ffc107; color: #212529;">
            P-1/P+1 Status
        </a>
        <a href="/api/v1/dashboard/curves" class="btn">
            All Curves
        </a>
        <a href="/api/v1/dashboard/factors" class="btn">
            All Factors
        </a>
        <a href="/api/v1/dashboard/leaderboard" class="btn">
            Leaderboard
        </a>
        <a href="/api/v1/dashboard/residue-status" class="btn">
            Residue Status
        </a>
    </div>
</div>

<div style="margin-bottom: 20px; padding: 15px; background: white; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
    <div style="margin-bottom: 10px; font-weight: 600; color: #333;">
        üîç Filter by Priority:
    </div>
    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <a href="/api/v1/dashboard/" class="btn {% if priority is none %}btn-primary{% else %}btn-secondary{% endif %}" style="padding: 8px 16px;">
            All Priorities
        </a>
        {% for p in range(1, 11) %}
        <a href="/api/v1/dashboard/?priority={{ p }}" class="btn {% if priority == p %}btn-primary{% else %}btn-secondary{% endif %}" style="padding: 8px 16px;">
            Priority {{ p }}
        </a>
        {% endfor %}
    </div>
    {% if priority is not none %}
    <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
        Currently showing: <strong>Priority {{ priority }}</strong> composites only
    </div>
    {% endif %}
</div>

<div class="stats-grid" style="margin-bottom: 30px;">
    <div class="stat-card">
        <div class="stat-number">{{ total_composites }}</div>
        <div class="stat-label">Total Composites</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ total_attempts }}</div>
        <div class="stat-label">Total Attempts</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ total_factors }}</div>
        <div class="stat-label">Factors Found</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ fully_factored }}</div>
        <div class="stat-label">Fully Factored</div>
    </div>
</div>

<div class="section">
    <div class="section-header">
        Recent Factorization Attempts (Aggregated by Composite)
        <a href="/api/v1/dashboard/curves" style="float: right; font-size: 0.85em; font-weight: normal;">View All Curves &rarr;</a>
    </div>
    <div class="section-content">
        <p style="margin-bottom: 15px; color: #666; font-style: italic;">
            Click any row to expand and see individual curve batches
        </p>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th></th>
                        <th>Composite</th>
                        <th>Digits</th>
                        <th>T-Level Progress</th>
                        <th>Batches</th>
                        <th>Total Curves</th>
                        <th>Factors Found</th>
                        <th>First/Last Attempt</th>
                        <th>Total Time</th>
                    </tr>
                </thead>
                <tbody>
                    {% for agg in attempts %}
                    {% set comp = agg.composite %}
                    {% set comp_display = (comp.number[:30] + '...') if comp.number|length > 30 else comp.number %}
                    {% set t_data = calc_t_progress(comp.current_t_level, comp.target_t_level, comp.ecm_progress) %}
                    {% set comp_digits = comp.current_composite|length if comp.current_composite else 0 %}
                    <!-- Main aggregated row -->
                    <tr class="composite-row" onclick="toggleExpand({{ comp.id }})" style="cursor: pointer; background: #f8f9fa;">
                        <td style="width: 30px; text-align: center;">
                            <span id="expand-icon-{{ comp.id }}" style="font-size: 1.2em;">‚ñ∂</span>
                        </td>
                        <td class="number">
                            <a href="/api/v1/dashboard/composites/{{ comp.id }}/details" style="color: inherit; text-decoration: none;" onclick="event.stopPropagation();">
                                <strong>{{ esc(comp_display) }}</strong>
                            </a>
                        </td>
                        <td>{{ comp_digits }}</td>
                        <td>
                            {% if t_data and t_data.target_t > 0 %}
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <div class="progress" style="width: 80px;">
                                    <div class="progress-bar" style="width: {{ [t_data.progress_pct, 100]|min }}%; background-color: {{ t_data.progress_color }}"></div>
                                </div>
                                <span class="small-text" style="font-weight: bold; color: {{ t_data.progress_color }}">
                                    t{{ t_data.current_t|round(1) }}/t{{ t_data.target_t|round(1) }}
                                </span>
                            </div>
                            {% else %}
                            <span style="color: #999;">N/A</span>
                            {% endif %}
                        </td>
                        <td><strong>{{ agg.attempt_count }}</strong></td>
                        <td><strong>{{ "{:,}".format(agg.total_curves) }}</strong></td>
                        <td>
                            {% if agg.factor_count > 0 %}
                            <span class="factor" style="font-weight: bold;">{{ agg.factor_count }} factor{{ 's' if agg.factor_count > 1 else '' }}</span>
                            {% else %}
                            None
                            {% endif %}
                        </td>
                        <td class="small-text">
                            {{ agg.earliest_attempt.strftime('%Y-%m-%d %H:%M') }}<br/>
                            {{ agg.latest_attempt.strftime('%Y-%m-%d %H:%M') }}
                        </td>
                        <td>{{ (agg.total_time|round(1)) }}s</td>
                    </tr>
                    <!-- Expandable rows for individual attempts -->
                    {% for attempt in agg.attempts %}
                    <tr id="detail-{{ comp.id }}-{{ attempt.id }}" class="detail-row" style="display: none; background: #fff;">
                        <td></td>
                        <td colspan="2" class="small-text" style="padding-left: 30px;">
                            {{ attempt.method.upper() }} - B1={{ "{:,}".format(attempt.b1) }}{% if attempt.b2 %}, B2={{ "{:,}".format(attempt.b2) }}{% endif %}
                        </td>
                        <td></td>
                        <td class="small-text">1 batch</td>
                        <td class="small-text">{{ attempt.curves_completed }} curves</td>
                        <td>
                            {% if attempt.factor_found %}
                            {% set fc = factor_counts_by_attempt.get(attempt.id, 1) %}
                            {% if fc > 1 %}
                            <span class="factor small-text">{{ attempt.factor_found[:15] }}... <strong style="color: #2ecc71;">[+{{ fc - 1 }}]</strong></span>
                            {% else %}
                            <span class="factor small-text">{{ attempt.factor_found[:20] }}{{ '...' if attempt.factor_found|length > 20 else '' }}</span>
                            {% endif %}
                            {% else %}
                            <span class="small-text">None</span>
                            {% endif %}
                        </td>
                        <td class="small-text">{{ attempt.created_at.strftime('%Y-%m-%d %H:%M') }}<br/>{{ attempt.client_id if attempt.client_id else 'Unknown' }}</td>
                        <td class="small-text">{{ (attempt.execution_time_seconds|round(1)) if attempt.execution_time_seconds else 'N/A' }}s</td>
                    </tr>
                    {% endfor %}
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="section">
    <div class="section-header">
        Recent Factors Found
        <a href="/api/v1/dashboard/factors" style="float: right; font-size: 0.85em; font-weight: normal;">View All {{ total_factors }} Factors &rarr;</a>
    </div>
    <div class="section-content">
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>Factor</th>
                        <th>Bits</th>
                        <th>Digits</th>
                        <th>Composite</th>
                        <th>Discovery Method</th>
                        <th>Sigma</th>
                        <th>Group Order</th>
                        <th>Discovered</th>
                    </tr>
                </thead>
                <tbody>
                    {% for factor in factors %}
                    {% set comp = factor_composites.get(factor.composite_id) %}
                    {% set attempt = factor_attempts.get(factor.found_by_attempt_id) %}
                    {% set comp_display = (comp.number[:40] + '...') if (comp and comp.number|length > 40) else (comp.number if comp else 'Unknown') %}
                    {% set method = attempt.method if attempt else 'Unknown' %}
                    {% set param = attempt.parametrization if attempt and attempt.parametrization is not none else '' %}
                    {% set factor_digits = factor.factor|length %}
                    {# Approximate bits from digits: bits ‚âà digits √ó log2(10) ‚âà digits √ó 3.322 #}
                    {% set factor_bits = (factor_digits * 3.322)|int if factor_digits > 0 else 0 %}
                    <tr>
                        <td class="factor number">{{ factor.factor }}</td>
                        <td>{{ factor_bits }}</td>
                        <td>{{ factor_digits }}</td>
                        <td class="number">
                            {% if comp %}
                            <a href="/api/v1/dashboard/composites/{{ comp.id }}/details" style="color: inherit; text-decoration: none;">
                                {{ comp_display }}
                            </a>
                            {% else %}
                            {{ comp_display }}
                            {% endif %}
                        </td>
                        <td>{{ method }}</td>
                        <td class="number">
                            {% if factor.sigma is not none and param %}
                                {{ param }}:{{ factor.sigma }}
                            {% elif factor.sigma is not none %}
                                {{ factor.sigma }}
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="number" style="font-size: 0.85em;">
                            {% if factor.group_order %}
                                <span title="{{ factor.group_order_factorization if factor.group_order_factorization else factor.group_order }}">
                                    {{ (factor.group_order[:30] + '...') if factor.group_order|length > 30 else factor.group_order }}
                                </span>
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td class="small-text">{{ factor.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="small-text" style="margin-top: 20px;">
    <p>API Documentation: <a href="/docs">/docs</a></p>
</div>
{% endblock %}
