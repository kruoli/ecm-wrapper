{% extends "base.html" %}

{% block title %}ECM Distributed Factorization Dashboard{% endblock %}

{% block extra_head %}
<script>
    // Auto-refresh every 30 seconds
    setTimeout(function() {
        window.location.reload();
    }, 30000);
</script>
{% endblock %}

{% block body %}
<h1>ECM Distributed Factorization Dashboard</h1>

<div class="stats-grid" style="margin-bottom: 30px;">
    <div class="stat-card">
        <div class="stat-number">{{ total_composites }}</div>
        <div class="stat-label">Total Composites</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ total_attempts }}</div>
        <div class="stat-label">Total Attempts</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ total_factors }}</div>
        <div class="stat-label">Factors Found</div>
    </div>
    <div class="stat-card">
        <div class="stat-number">{{ fully_factored }}</div>
        <div class="stat-label">Fully Factored</div>
    </div>
</div>

<div class="section">
    <div class="section-header">Recent Factorization Attempts</div>
    <div class="section-content">
        <table>
            <thead>
                <tr>
                    <th>Composite</th>
                    <th>Bits</th>
                    <th>Digits</th>
                    <th>T-Level Progress</th>
                    <th>Method</th>
                    <th>B1</th>
                    <th>Curves</th>
                    <th>Factor Found</th>
                    <th>Client</th>
                    <th>Time</th>
                    <th>Submitted</th>
                </tr>
            </thead>
            <tbody>
                {% for attempt in attempts %}
                {% set comp = db.query(Composite).filter(Composite.id == attempt.composite_id).first() %}
                {% set comp_display = (comp.number[:30] + '...') if (comp and comp.number|length > 30) else (comp.number if comp else 'Unknown') %}
                {% set t_data = calc_t_progress(comp.current_t_level, comp.target_t_level) if comp else None %}
                {% set comp_digits = comp.current_composite|length if comp and comp.current_composite else 0 %}
                {# Approximate bits from digits: bits ≈ digits × log2(10) ≈ digits × 3.322 #}
                {% set comp_bits = (comp_digits * 3.322)|int if comp_digits > 0 else 0 %}
                <tr>
                    <td class="number">
                        {% if comp %}
                        <a href="/api/v1/dashboard/composites/{{ comp.id }}/details" style="color: inherit; text-decoration: none;">
                            {{ comp_display }}
                        </a>
                        {% else %}
                        {{ comp_display }}
                        {% endif %}
                    </td>
                    <td>{{ comp_bits if comp_bits > 0 else 'N/A' }}</td>
                    <td>{{ comp_digits if comp_digits > 0 else 'N/A' }}</td>
                    <td>
                        {% if t_data and t_data.target_t > 0 %}
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <div class="progress" style="width: 80px;">
                                <div class="progress-bar" style="width: {{ [t_data.progress_pct, 100]|min }}%; background-color: {{ t_data.progress_color }}"></div>
                            </div>
                            <span class="small-text" style="font-weight: bold; color: {{ t_data.progress_color }}">
                                t{{ t_data.current_t|round(1) }}/t{{ t_data.target_t|round(1) }}
                            </span>
                        </div>
                        {% else %}
                        <span style="color: #999;">N/A</span>
                        {% endif %}
                    </td>
                    <td>{{ attempt.method }}</td>
                    <td>{{ attempt.b1 if attempt.b1 else 'N/A' }}</td>
                    <td>{{ attempt.curves_completed }}</td>
                    <td>
                        {% if attempt.factor_found %}
                        <span class="factor">{{ attempt.factor_found }}</span>
                        {% else %}
                        None
                        {% endif %}
                    </td>
                    <td class="small-text">{{ attempt.client_id if attempt.client_id else 'Unknown' }}</td>
                    <td>{{ (attempt.execution_time_seconds|round(1) if attempt.execution_time_seconds is not none else 'N/A') }}{{ 's' if attempt.execution_time_seconds is not none else '' }}</td>
                    <td class="small-text">{{ attempt.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="section">
    <div class="section-header">All Factors Found</div>
    <div class="section-content">
        <table>
            <thead>
                <tr>
                    <th>Factor</th>
                    <th>Bits</th>
                    <th>Digits</th>
                    <th>Composite</th>
                    <th>Discovery Method</th>
                    <th>Sigma</th>
                    <th>Group Order</th>
                    <th>Discovered</th>
                </tr>
            </thead>
            <tbody>
                {% for factor in factors %}
                {% set comp = db.query(Composite).filter(Composite.id == factor.composite_id).first() %}
                {% set attempt = db.query(ECMAttempt).filter(ECMAttempt.id == factor.found_by_attempt_id).first() %}
                {% set comp_display = (comp.number[:40] + '...') if (comp and comp.number|length > 40) else (comp.number if comp else 'Unknown') %}
                {% set method = attempt.method if attempt else 'Unknown' %}
                {% set param = attempt.parametrization if attempt and attempt.parametrization is not none else '' %}
                {% set factor_digits = factor.factor|length %}
                {# Approximate bits from digits: bits ≈ digits × log2(10) ≈ digits × 3.322 #}
                {% set factor_bits = (factor_digits * 3.322)|int if factor_digits > 0 else 0 %}
                <tr>
                    <td class="factor number">{{ factor.factor }}</td>
                    <td>{{ factor_bits }}</td>
                    <td>{{ factor_digits }}</td>
                    <td class="number">
                        {% if comp %}
                        <a href="/api/v1/dashboard/composites/{{ comp.id }}/details" style="color: inherit; text-decoration: none;">
                            {{ comp_display }}
                        </a>
                        {% else %}
                        {{ comp_display }}
                        {% endif %}
                    </td>
                    <td>{{ method }}</td>
                    <td class="number">
                        {% if factor.sigma is not none and param %}
                            {{ param }}:{{ factor.sigma }}
                        {% elif factor.sigma is not none %}
                            {{ factor.sigma }}
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td class="number" style="font-size: 0.85em;">
                        {% if factor.group_order %}
                            <span title="{{ factor.group_order_factorization if factor.group_order_factorization else factor.group_order }}">
                                {{ (factor.group_order[:30] + '...') if factor.group_order|length > 30 else factor.group_order }}
                            </span>
                        {% else %}
                            N/A
                        {% endif %}
                    </td>
                    <td class="small-text">{{ factor.created_at.strftime('%Y-%m-%d %H:%M') }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div class="small-text" style="margin-top: 20px;">
    <p>Dashboard auto-refreshes every 30 seconds. API Documentation: <a href="/docs">/docs</a></p>
</div>
{% endblock %}
