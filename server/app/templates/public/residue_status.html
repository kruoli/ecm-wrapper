{% extends "base.html" %}

{% block title %}Residue Status - ECM Distributed Factorization{% endblock %}

{% block extra_head %}
<style>
    .stat-card-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 15px;
        margin-bottom: 25px;
    }

    .stat-card-mini {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        text-align: center;
    }

    .stat-card-mini .stat-value {
        font-size: 1.8em;
        font-weight: bold;
        color: #667eea;
    }

    .stat-card-mini .stat-label {
        font-size: 0.85em;
        color: #666;
        margin-top: 5px;
    }

    .nav-links {
        margin-bottom: 20px;
    }

    .nav-links a {
        color: #667eea;
        text-decoration: none;
        margin-right: 15px;
        font-weight: 500;
    }

    .nav-links a:hover {
        text-decoration: underline;
    }
</style>
{% endblock %}

{% block body %}
<div class="nav-links">
    <a href="/api/v1/dashboard/">← Back to Dashboard</a>
    <a href="/api/v1/dashboard/testing-status">ECM Testing Status</a>
    <a href="/api/v1/dashboard/p1-testing-status">P-1/P+1 Testing Status</a>
</div>

<h1>Residue Pool Status</h1>

<!-- Summary Stats -->
<div class="stat-card-grid">
    <div class="stat-card-mini">
        <div class="stat-value" style="color: #28a745;">{{ stats.get('total_available', 0) }}</div>
        <div class="stat-label">Available</div>
    </div>
    <div class="stat-card-mini">
        <div class="stat-value" style="color: #ffc107;">{{ stats.get('total_claimed', 0) }}</div>
        <div class="stat-label">Claimed</div>
    </div>
    <div class="stat-card-mini">
        <div class="stat-value" style="color: #6c757d;">{{ stats.get('total_completed', 0) }}</div>
        <div class="stat-label">Completed</div>
    </div>
    <div class="stat-card-mini">
        <div class="stat-value" style="color: #dc3545;">{{ stats.get('total_expired', 0) }}</div>
        <div class="stat-label">Expired</div>
    </div>
    <div class="stat-card-mini">
        <div class="stat-value">{{ "{:,}".format(stats.get('total_curves_pending', 0)) }}</div>
        <div class="stat-label">Pending Curves</div>
    </div>
</div>

<!-- Filters -->
<div class="section">
    <div class="section-header">Filters</div>
    <div class="section-content">
        <form method="GET" action="/api/v1/dashboard/residue-status" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: flex-end;">
            <div style="flex: 1; min-width: 150px;">
                <label for="status" style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em;">Status</label>
                <select id="status" name="status" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                    <option value="">All Statuses</option>
                    <option value="available" {{ 'selected' if filter_status == 'available' else '' }}>Available</option>
                    <option value="claimed" {{ 'selected' if filter_status == 'claimed' else '' }}>Claimed</option>
                    <option value="completed" {{ 'selected' if filter_status == 'completed' else '' }}>Completed</option>
                    <option value="expired" {{ 'selected' if filter_status == 'expired' else '' }}>Expired</option>
                </select>
            </div>
            <div style="flex: 1; min-width: 150px;">
                <label for="composite_id" style="display: block; margin-bottom: 5px; font-weight: 500; font-size: 0.9em;">Composite ID</label>
                <input type="number" id="composite_id" name="composite_id"
                       value="{{ filter_composite_id or '' }}"
                       placeholder="All composites"
                       style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
            </div>
            <div style="display: flex; gap: 10px; align-items: flex-end;">
                <button type="submit" style="padding: 8px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 500;">
                    Apply Filters
                </button>
                <a href="/api/v1/dashboard/residue-status" style="padding: 8px 20px; background-color: #6c757d; color: white; text-decoration: none; border-radius: 4px; display: inline-block; font-weight: 500;">
                    Clear Filters
                </a>
            </div>
        </form>
    </div>
</div>

<!-- Residues Table -->
<div class="section">
    <div class="section-header">ECM Residues</div>
    <div class="section-content">
        {% if residues %}
        <p style="margin-bottom: 10px; color: #666; font-style: italic;">
            Showing {{ showing_from }} to {{ showing_to }} of {{ total }} residues
        </p>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Composite</th>
                        <th>Status</th>
                        <th>B1</th>
                        <th>Param</th>
                        <th>Curves</th>
                        <th>File Size</th>
                        <th>Uploaded By</th>
                        <th>Created</th>
                        <th>Expires / Time Remaining</th>
                    </tr>
                </thead>
                <tbody>
                    {% for residue in residues %}
                    {% set composite = residue.composite %}
                    {% set time_remaining = format_time(residue.expires_at, now) %}
                    {% set is_expiring_soon = (residue.expires_at - now).total_seconds() < 86400 if residue.expires_at else False %}
                    <tr>
                        <td>{{ residue.id }}</td>
                        <td>
                            {% if composite %}
                            <a href="/api/v1/dashboard/composites/{{ composite.id }}/details" class="number" style="color: #667eea; text-decoration: none;">
                                {{ esc(format_composite(composite.number, 30)) }}
                            </a>
                            {% else %}
                            <span class="small-text">Unknown</span>
                            {% endif %}
                        </td>
                        <td>
                            <span style="display: inline-block; padding: 4px 8px; border-radius: 4px; font-weight: bold;
                                {% if residue.status == 'available' %}
                                    background: #28a745; color: white;
                                {% elif residue.status == 'claimed' %}
                                    background: #ffc107; color: black;
                                {% elif residue.status == 'completed' %}
                                    background: #6c757d; color: white;
                                {% elif residue.status == 'expired' %}
                                    background: #dc3545; color: white;
                                {% endif %}
                            ">
                                {{ residue.status }}
                            </span>
                        </td>
                        <td>{{ "{:,}".format(residue.b1) if residue.b1 else 'N/A' }}</td>
                        <td>{{ residue.parametrization if residue.parametrization is not none else 'N/A' }}</td>
                        <td>{{ residue.curve_count if residue.curve_count else 'N/A' }}</td>
                        <td>
                            {% if residue.file_size_bytes %}
                                {{ "%.1f" % (residue.file_size_bytes / 1024 / 1024) }} MB
                            {% else %}
                                N/A
                            {% endif %}
                        </td>
                        <td>{{ esc(residue.client_id) if residue.client_id else 'N/A' }}</td>
                        <td>{{ residue.created_at.strftime('%Y-%m-%d %H:%M') if residue.created_at else 'N/A' }}</td>
                        <td {% if is_expiring_soon %}style="color: #dc3545; font-weight: bold;"{% endif %}>
                            {{ time_remaining }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div style="margin-top: 20px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px;">
            <div style="color: #666;">
                <strong>Page {{ page }} of {{ total_pages }}</strong>
                ({{ showing_from }}-{{ showing_to }} of {{ total }} residues)
            </div>
            <div style="display: flex; gap: 10px;">
                {% if has_prev %}
                <a href="?offset={{ offset - limit }}&limit={{ limit }}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_composite_id %}&composite_id={{ filter_composite_id }}{% endif %}"
                   style="padding: 8px 16px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; font-weight: 500;">
                    ← Previous
                </a>
                {% else %}
                <span style="padding: 8px 16px; background-color: #e9ecef; color: #6c757d; border-radius: 4px; font-weight: 500;">
                    ← Previous
                </span>
                {% endif %}

                {% if has_next %}
                <a href="?offset={{ offset + limit }}&limit={{ limit }}{% if filter_status %}&status={{ filter_status }}{% endif %}{% if filter_composite_id %}&composite_id={{ filter_composite_id }}{% endif %}"
                   style="padding: 8px 16px; background-color: #007bff; color: white; text-decoration: none; border-radius: 4px; font-weight: 500;">
                    Next →
                </a>
                {% else %}
                <span style="padding: 8px 16px; background-color: #e9ecef; color: #6c757d; border-radius: 4px; font-weight: 500;">
                    Next →
                </span>
                {% endif %}
            </div>
        </div>

        {% else %}
        <p>No residues found matching the current filters.</p>
        {% endif %}
    </div>
</div>

<div class="small-text" style="margin-top: 20px;">
    <p>
        <strong>Status Legend:</strong>
        <span style="display: inline-block; padding: 2px 6px; border-radius: 3px; background: #28a745; color: white; font-size: 0.85em;">available</span> Ready for stage 2 |
        <span style="display: inline-block; padding: 2px 6px; border-radius: 3px; background: #ffc107; color: black; font-size: 0.85em;">claimed</span> Being processed |
        <span style="display: inline-block; padding: 2px 6px; border-radius: 3px; background: #6c757d; color: white; font-size: 0.85em;">completed</span> Stage 2 done |
        <span style="display: inline-block; padding: 2px 6px; border-radius: 3px; background: #dc3545; color: white; font-size: 0.85em;">expired</span> Claim timed out
    </p>
    <p><a href="/api/v1/dashboard/">Back to Dashboard</a></p>
</div>
{% endblock %}
